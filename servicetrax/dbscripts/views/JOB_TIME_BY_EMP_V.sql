
CREATE VIEW JOB_TIME_BY_EMP_V
AS
SELECT dbo.TIME_CAPTURE_V.ORGANIZATION_ID, 
       dbo.TIME_CAPTURE_V.TC_JOB_NO, 
       dbo.TIME_CAPTURE_V.TC_SERVICE_NO, 
       dbo.TIME_CAPTURE_V.TC_SERVICE_LINE_NO, 
       dbo.TIME_CAPTURE_V.TC_JOB_ID, 
       dbo.TIME_CAPTURE_V.TC_SERVICE_ID, 
       dbo.TIME_CAPTURE_V.SERVICE_LINE_ID, 
       dbo.JOBS_V.JOB_NAME, 
       dbo.JOBS_V.FOREMAN_RESOURCE_ID, 
       dbo.JOBS_V.foreman_resource_name, 
       dbo.TIME_CAPTURE_V.SERVICE_LINE_DATE, 
       dbo.TIME_CAPTURE_V.STATUS_ID, 
       dbo.TIME_CAPTURE_V.status_name, 
       dbo.TIME_CAPTURE_V.RESOURCE_ID, 
       dbo.RESOURCES_V.USER_ID, 
       dbo.RESOURCES_V.resource_name, 
       dbo.RESOURCES_V.user_full_name AS employee_name, 
       dbo.RESOURCES_V.EXT_EMPLOYEE_ID, 
       dbo.TIME_CAPTURE_V.ITEM_NAME, 
       dbo.TIME_CAPTURE_V.PAYROLL_QTY, 
       dbo.TIME_CAPTURE_V.PAYROLL_RATE, 
       dbo.TIME_CAPTURE_V.PAYROLL_TOTAL, 
       dbo.TIME_CAPTURE_V.EXPENSE_QTY, 
       dbo.TIME_CAPTURE_V.EXPENSE_RATE, 
       dbo.TIME_CAPTURE_V.EXPENSE_TOTAL, 
       dbo.TIME_CAPTURE_V.TC_QTY, 
       dbo.TIME_CAPTURE_V.TC_RATE, 
       dbo.TIME_CAPTURE_V.TC_TOTAL, 
       dbo.TIME_CAPTURE_V.BILL_HOURLY_QTY, 
       dbo.TIME_CAPTURE_V.BILL_HOURLY_RATE, 
       dbo.TIME_CAPTURE_V.BILL_HOURLY_TOTAL, 
       dbo.TIME_CAPTURE_V.BILL_EXP_QTY, 
       dbo.TIME_CAPTURE_V.BILL_EXP_RATE, 
       dbo.TIME_CAPTURE_V.BILL_EXP_TOTAL, 
       dbo.TIME_CAPTURE_V.BILL_QTY,  
       dbo.TIME_CAPTURE_V.BILL_RATE, 
       dbo.TIME_CAPTURE_V.BILL_TOTAL, 
       dbo.TIME_CAPTURE_V.PH_SERVICE_ID, 
       dbo.TIME_CAPTURE_V.EXT_PAY_CODE, 
       dbo.TIME_CAPTURE_V.service_no,
       ISNULL(dbo.TIME_CAPTURE_V.PAYROLL_QTY, 0) - ISNULL(dbo.TIME_CAPTURE_V.BILL_HOURLY_QTY, 0) AS hours_difference, 
       MAX((CASE WHEN SERVICE_LINES_SCHD_V.SERVICE_LINE_ID IS NULL THEN 'N' ELSE 'Y' END)) scheduled_flag
  FROM dbo.SERVICE_LINES_SCHD_V RIGHT OUTER JOIN
       dbo.TIME_CAPTURE_V ON dbo.SERVICE_LINES_SCHD_V.SERVICE_LINE_ID = dbo.TIME_CAPTURE_V.SERVICE_LINE_ID LEFT OUTER JOIN
       dbo.RESOURCES_V ON dbo.TIME_CAPTURE_V.RESOURCE_ID = dbo.RESOURCES_V.RESOURCE_ID LEFT OUTER JOIN
       dbo.JOBS_V ON dbo.TIME_CAPTURE_V.TC_JOB_ID = dbo.JOBS_V.JOB_ID
GROUP BY dbo.TIME_CAPTURE_V.ORGANIZATION_ID, dbo.TIME_CAPTURE_V.TC_JOB_NO, dbo.TIME_CAPTURE_V.TC_SERVICE_NO, 
         dbo.TIME_CAPTURE_V.TC_SERVICE_LINE_NO, dbo.TIME_CAPTURE_V.TC_JOB_ID, dbo.TIME_CAPTURE_V.TC_SERVICE_ID, 
         dbo.TIME_CAPTURE_V.SERVICE_LINE_ID, dbo.JOBS_V.JOB_NAME, dbo.JOBS_V.FOREMAN_RESOURCE_ID, dbo.JOBS_V.foreman_resource_name, 
         dbo.TIME_CAPTURE_V.SERVICE_LINE_DATE, dbo.TIME_CAPTURE_V.STATUS_ID, dbo.TIME_CAPTURE_V.status_name, 
         dbo.TIME_CAPTURE_V.RESOURCE_ID, dbo.RESOURCES_V.USER_ID, dbo.RESOURCES_V.resource_name, dbo.RESOURCES_V.user_full_name, 
         dbo.RESOURCES_V.EXT_EMPLOYEE_ID,
         dbo.TIME_CAPTURE_V.ITEM_NAME, dbo.TIME_CAPTURE_V.PAYROLL_QTY, 
         dbo.TIME_CAPTURE_V.PAYROLL_RATE, dbo.TIME_CAPTURE_V.PAYROLL_TOTAL, dbo.TIME_CAPTURE_V.EXPENSE_QTY, 
         dbo.TIME_CAPTURE_V.EXPENSE_RATE, dbo.TIME_CAPTURE_V.EXPENSE_TOTAL, dbo.TIME_CAPTURE_V.TC_QTY, dbo.TIME_CAPTURE_V.TC_RATE, 
         dbo.TIME_CAPTURE_V.TC_TOTAL, dbo.TIME_CAPTURE_V.BILL_HOURLY_QTY, dbo.TIME_CAPTURE_V.BILL_HOURLY_RATE, 
         dbo.TIME_CAPTURE_V.BILL_HOURLY_TOTAL, dbo.TIME_CAPTURE_V.BILL_EXP_QTY, dbo.TIME_CAPTURE_V.BILL_EXP_RATE, 
         dbo.TIME_CAPTURE_V.BILL_EXP_TOTAL, dbo.TIME_CAPTURE_V.BILL_QTY,dbo.TIME_CAPTURE_V.BILL_RATE, dbo.TIME_CAPTURE_V.BILL_TOTAL, 
         dbo.TIME_CAPTURE_V.PH_SERVICE_ID, dbo.TIME_CAPTURE_V.EXT_PAY_CODE,
         dbo.TIME_CAPTURE_V.service_no, ISNULL(dbo.TIME_CAPTURE_V.PAYROLL_QTY, 0) - ISNULL(dbo.TIME_CAPTURE_V.BILL_HOURLY_QTY, 0)
HAVING   (NOT (dbo.TIME_CAPTURE_V.PAYROLL_QTY IS NULL))


